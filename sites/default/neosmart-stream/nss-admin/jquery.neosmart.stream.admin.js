/************************************************************************************************************************************
 *	neosmart STREAM - admin area
 *
 *	@copyright:			neosmart GmbH
 *	@licence:			https://neosmart-stream.de/legal/license-agreement/
 *	@documentation:		https://neosmart-stream.de/docs/
 *	@last update:		2013-05-16
 *	
 ************************************************************************************************************************************/
(function(a){a.fn.neosmartStreamAdmin=function(s){var c=a.extend({},a.fn.neosmartStreamAdmin.defaults,s);var k=this;r();function r(){if(a('input[name="access_token_expires"]').length){a('input[name="access_token_expires"]').on("change focus keyup blur",g).trigger("keyup");setInterval(j,1000)}if(a(".nss-admin-add-channel").length){l()}e()}function l(){a(".edit-channel").each(function(o,t){a(t).click(function(u){a(".nss-admin-channel").hide();a("#add-channel-error").hide();a(".channel-id-"+o).fadeIn()})});a(".nss-admin-remove").unbind("click").click(q);a(".nss-admin-add-channel").click(f);a(".save-channels").click(function(o){var t=a(this).attr("data-pos");n(false,t)});a(".atc-button").click(function(t){var o=a(t.currentTarget);b(o.attr("data-id"))});a("#new-channel-type").change(d);m()}function e(){var t=a('[name="feedback_header_fb_send"]');var o=a('[name="feedback_header_fb_like"]');if(!t.length){return false}o.on("change",function(w){var u=o.filter(":checked").val();if(u=="0"){t.filter('[value="0"]').attr("checked",true)}});t.on("change",function(w){var u=t.filter(":checked").val();if(u=="1"){o.filter('[value="1"]').attr("checked",true)}})}function j(){a('input[name="access_token_expires"]:not(.nss-unknown-time)').trigger("keyup")}function m(){a(".nss-admin-channel").each(function(y,v){var B=a(v);var A=B.attr("data-channel");var u,t,w,z,x=1;B.find(".nss-admin-test").click(function(C){B.find(".channel-status").html("testing ...").addClass("loading");switch(A){case"facebook":u=B.find('input[name="id"]').val();w=B.find('input[name="access_token"]').val();x=B.find('input[name="limit"]').val();z=B.find('select[name="show_all"]').val();i("facebook",B,u,t,w,z,x);break;case"twitter":u=B.find('input[name="id"]').val();i("twitter",B,u,t,w,z,x);break;case"nss":t=B.find('input[name="url"]').val();i("nss",B,u,t,w,z,x);break}})});var o=a("#channels").attr("data-test");if(o=="auto"){a(".nss-admin-test").each(function(t,u){a(u).trigger("click")})}}function i(x,w,y,u,v,t,o){a.ajax({url:"ajax-test-channel.php",data:"channel="+x+"&id="+y+"&url="+u+"&token="+v+"&show_all="+t+"&limit="+o,type:"post",complete:function(z){w.find(".channel-status").html(z.responseText).removeClass("loading")}})}function d(){var o=a("#new-channel-type").val();a(".new-channel-container").hide();a("#add-channel-error").hide();a('.nss-admin-channel[data-channel!="new"]').hide();switch(o){case"facebook":a("#nss-admin-add-channel-facebook").fadeIn();break;case"twitter":a("#nss-admin-add-channel-twitter").fadeIn();break;case"nss":a("#nss-admin-add-channel-nss").fadeIn();break}}function g(v){var C=a(v.currentTarget);var B=parseInt(C.val())*1000;var w=new Date();var z=B-w.getTime();var t=z;var o="";var A=Math.floor(z/(60*60*24*1000));z-=A*(60*60*24*1000);var x=Math.floor(z/(60*60*1000));z-=x*(60*60*1000);var u=Math.floor(z/(60*1000));z-=u*(60*1000);var y=Math.floor(z/1000);if(A>1){o+=A+" days "}else{if(A==1){o+=A+" day "}}if(x>1){o+=x+" hours "}else{if(x==1){o+=x+" hour "}}if(u>1){o+=u+" minutes "}else{if(u==1){o+=u+" minute "}}if(y>1){o+=y+" seconds "}else{if(y==1){o+=y+" second "}}if(t<=0){o="Access token is expired"}if(parseInt(C.val())==0){C.addClass("nss-unknown-time");o='unknown - <a href="https://developers.facebook.com/tools/debug/access_token?q='+C.parent().find('[name="access_token"]').val()+'" target="_blank">Check<a/>'}C.parent().find(".expires_in_real_time").html(o)}function n(u,v){var t="";var o=u===true?".nss-admin-channel":'.nss-admin-channel:not([data-channel="new"])';a(o).each(function(C,z){var F=a(z);var E=F.attr("data-channel");var x,D,A,w,y,B;if(E=="new"){E=a("#new-channel-type").val();F=a("#nss-admin-add-channel-"+E)}switch(E){case"facebook":x=a.trim(F.find('input[name="id"]').val());D=a.trim(F.find('input[name="access_token"]').val());A=parseInt(F.find('input[name="limit"]').val());if(isNaN(A)){A=0}F.find('input[name="limit"]').val(A);B=F.find('[name="show_all"]').val();y=F.find('[name="access_token_expires"]').val();if(!y||!D){y=0}t+="$nss->addChannel('facebook','"+x+"','"+D+"',"+A+",'"+B+"',"+y+");\n";break;case"twitter":x=F.find('input[name="id"]').val();A=parseInt(F.find('input[name="limit"]').val());if(isNaN(A)||A<1){A=1}t+="$nss->addChannel('twitter','"+x+"',"+A+");\n";break;case"nss":w=F.find('input[name="url"]').val();t+="$nss->addChannel('nss','"+w+"');\n";break}});a.ajax({url:"index.php",data:"action=update_channels&channels="+t,type:"post",complete:function(x){var w=document.location.href;w=w.substr(0,w.lastIndexOf("channels.php"))+"channels.php?saved=1";target=v===false?"":"&pos="+v;document.location.href=w+target}})}function q(t){var o=a(t.currentTarget).parent().parent();o.fadeOut(500,function(){o.remove();n(false)})}function p(t,o){a.ajax({url:"https://graph.facebook.com/"+t+"/feed/?access_token="+o,complete:function(u){}})}function f(){var w=a("#new-channel-type").val();var u=a("#add-channel-error").hide();var t=new Date();var v=w+"_"+Math.round(Math.random()*99999999)+"_"+t.getTime();var o="";var x;switch(w){case"facebook":x=a("#nss-admin-add-channel-facebook");if(x.find('input[name="id"]').val()==""){o+="<p>Enter Your Facebook ID</p>"}if(x.find('input[name="access_token"]').val()==""){o+="<p>Enter a valid Access Token</p>"}break;case"twitter":x=a("#nss-admin-add-channel-twitter");if(x.find('input[name="id"]').val()==""){o+="<p>Enter Your Twitter ID</p>"}break;case"nss":x=a("#nss-admin-add-channel-nss");if(x.find('input[name="url"]').val()==""){o+="<p>Enter Your NSS URL</p>"}break}if(o!=""){u.html('<div class="row">'+o+"</div>").fadeIn();return false}n(true,false)}function h(o){o?a(".not-saved").fadeIn(500):a(".not-saved").fadeOut(500)}function b(v){var t=window.open("atc.php","ATC","width=1000,height=500,left=100,top=100");var u=a(".channel-id-"+v);t.focus();var o=setInterval(function(){try{var w=t.$.find("#atc-access-token");var y=a(w);if(y.length){var z=t.$.find("#atc-expires");var x=a(z);u.find('input[name="access_token"]').val(y.text());u.find('input[name="access_token_expires"]').val(x.text()).trigger("change").parent().parent().fadeIn();t.close();clearInterval(o);h(true)}}catch(z){}},1000)}return k};a.fn.neosmartStreamAdmin.defaults={}})(jQuery);